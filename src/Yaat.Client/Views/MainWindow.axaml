<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Yaat.Client.ViewModels"
        xmlns:svc="using:Yaat.Client.Services"
        x:Class="Yaat.Client.Views.MainWindow"
        Title="YAAT">

    <Design.DataContext>
        <vm:MainViewModel />
    </Design.DataContext>

    <Panel>

    <DockPanel Margin="12">

        <!-- Top bar: URL + Connect + Settings -->
        <Grid DockPanel.Dock="Top"
              Margin="0,0,0,8"
              ColumnDefinitions="Auto,Auto,*,Auto">
            <TextBox Grid.Column="0"
                     Text="{Binding ServerUrl}"
                     Watermark="Server URL"
                     Width="300" />
            <Button Grid.Column="1"
                    Margin="8,0,0,0"
                    Content="{Binding IsConnected,
                    Converter={x:Static
                    vm:ConnectButtonConverter.Instance}}"
                    Command="{Binding ConnectCommand}" />
            <TextBlock Grid.Column="2"
                       Text="{Binding StatusText}"
                       VerticalAlignment="Center"
                       Margin="12,0,0,0"
                       Foreground="Gray" />
            <Button Grid.Column="3"
                    Content="Settings"
                    x:Name="SettingsButton" />
        </Grid>

        <!-- Scenario bar -->
        <StackPanel DockPanel.Dock="Top"
                    Orientation="Horizontal"
                    Spacing="8"
                    Margin="0,0,0,8">
            <TextBox Text="{Binding ScenarioFilePath}"
                     Watermark="Scenario JSON file..."
                     Width="400" />
            <Button Content="Browse"
                    x:Name="BrowseButton" />
            <Button Content="Load Scenario"
                    Command="{Binding LoadScenarioCommand}" />
            <Button Content="Delete All"
                    Command="{Binding DeleteAllCommand}" />

            <!-- Active scenario indicator -->
            <TextBlock VerticalAlignment="Center"
                       Margin="8,0,0,0"
                       Foreground="CornflowerBlue"
                       IsVisible="{Binding ActiveScenarioName,
                           Converter={x:Static
                           StringConverters.IsNotNullOrEmpty}}"
                       Text="{Binding ActiveScenarioName,
                           StringFormat='Scenario: {0}'}" />
            <TextBlock VerticalAlignment="Center"
                       Foreground="Gray"
                       IsVisible="{Binding ActiveScenarioName,
                           Converter={x:Static
                           StringConverters.IsNotNullOrEmpty}}"
                       Text="{Binding ScenarioClientCount,
                           StringFormat='({0} client(s))'}" />
        </StackPanel>

        <!-- Bottom: Command bar + sim controls -->
        <Grid DockPanel.Dock="Bottom"
              Margin="0,8,0,0"
              ColumnDefinitions="Auto,*,Auto,Auto,Auto">

            <!-- Selected aircraft label -->
            <TextBlock Grid.Column="0"
                       VerticalAlignment="Center"
                       Margin="0,0,8,0"
                       FontWeight="Bold"
                       Text="{Binding SelectedAircraft.Callsign,
                              FallbackValue='(none)',
                              TargetNullValue='(none)'}" />

            <!-- Command input with autocomplete popup -->
            <Panel Grid.Column="1">
                <TextBox Text="{Binding CommandText}"
                         Watermark="Enter command (FH 270, CM 240...)"
                         x:Name="CommandInput" />
                <Popup IsOpen="{Binding CommandInput.IsSuggestionsVisible}"
                       PlacementTarget="{Binding #CommandInput}"
                       Placement="Top"
                       IsLightDismissEnabled="False"
                       MaxHeight="240"
                       Width="{Binding #CommandInput.Bounds.Width}">
                    <Border Background="#2D2D30"
                            BorderBrush="#3F3F46"
                            BorderThickness="1"
                            CornerRadius="4">
                        <ListBox ItemsSource="{Binding
                                     CommandInput.Suggestions}"
                                 SelectedIndex="{Binding
                                     CommandInput.SelectedSuggestionIndex}"
                                 Focusable="False"
                                 x:Name="SuggestionList"
                                 Background="Transparent"
                                 Padding="2">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="Auto,*">
                                        <TextBlock Grid.Column="0"
                                            Text="{Binding Text}"
                                            FontWeight="Bold"
                                            FontFamily="Consolas"
                                            Margin="4,2" />
                                        <TextBlock Grid.Column="1"
                                            Text="{Binding Description}"
                                            Foreground="Gray"
                                            Margin="8,2,4,2" />
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Border>
                </Popup>
            </Panel>

            <!-- Sim controls -->
            <Button Grid.Column="2"
                    Margin="8,0,0,0"
                    Content="{Binding IsPaused,
                        Converter={x:Static
                        vm:PauseButtonConverter.Instance}}"
                    Command="{Binding TogglePauseCommand}" />

            <ComboBox Grid.Column="3"
                      Margin="8,0,0,0"
                      ItemsSource="{Binding SimRateOptions}"
                      SelectedIndex="{Binding SelectedSimRateIndex}"
                      MinWidth="70">
                <ComboBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding StringFormat='{}{0}x'}" />
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>

        </Grid>

        <!-- Center: Aircraft DataGrid -->
        <DataGrid ItemsSource="{Binding Aircraft}"
                  SelectedItem="{Binding SelectedAircraft}"
                  AutoGenerateColumns="False"
                  IsReadOnly="True"
                  GridLinesVisibility="Horizontal"
                  CanUserResizeColumns="True"
                  SelectionMode="Single">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Callsign"
                    Binding="{Binding Callsign}"
                    Width="90" />
                <DataGridTextColumn Header="Status"
                    Binding="{Binding Status}"
                    Width="120" />
                <DataGridTextColumn Header="Type"
                    Binding="{Binding AircraftType}"
                    Width="60" />
                <DataGridTextColumn Header="Rules"
                    Binding="{Binding FlightRules}"
                    Width="40" />
                <DataGridTextColumn Header="Dep"
                    Binding="{Binding Departure}"
                    Width="50" />
                <DataGridTextColumn Header="Dest"
                    Binding="{Binding Destination}"
                    Width="50" />
                <DataGridTextColumn Header="Squawk"
                    Binding="{Binding BeaconCode,
                    StringFormat=\{0:D4\}}"
                    Width="55" />
                <DataGridTextColumn Header="Hdg"
                    Binding="{Binding Heading,
                    StringFormat=\{0:F0\}}"
                    Width="45" />
                <DataGridTextColumn Header="Alt"
                    Binding="{Binding Altitude,
                    StringFormat=\{0:F0\}}"
                    Width="60" />
                <DataGridTextColumn Header="Spd"
                    Binding="{Binding GroundSpeed,
                    StringFormat=\{0:F0\}}"
                    Width="45" />
                <DataGridTextColumn Header="VS"
                    Binding="{Binding VerticalSpeed,
                    StringFormat=\{0:F0\}}"
                    Width="50" />
                <DataGridTextColumn Header="AHdg"
                    Binding="{Binding AssignedHeading,
                    StringFormat=\{0:F0\}}"
                    Width="50" />
                <DataGridTextColumn Header="AAlt"
                    Binding="{Binding AssignedAltitude,
                    StringFormat=\{0:F0\}}"
                    Width="55" />
                <DataGridTextColumn Header="ASpd"
                    Binding="{Binding AssignedSpeed,
                    StringFormat=\{0:F0\}}"
                    Width="50" />
            </DataGrid.Columns>
        </DataGrid>

    </DockPanel>

    <!-- Delete-all confirmation overlay -->
    <Border IsVisible="{Binding ShowDeleteAllConfirmation}"
            Background="#CC000000"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            CornerRadius="8"
            Padding="24"
            MinWidth="350">
        <StackPanel Spacing="12">
            <TextBlock Text="Delete All Aircraft?"
                       FontSize="16"
                       FontWeight="Bold"
                       Foreground="White" />
            <TextBlock Text="{Binding PendingDeleteAllWarning}"
                       TextWrapping="Wrap"
                       Foreground="Orange" />
            <StackPanel Orientation="Horizontal"
                        Spacing="8"
                        HorizontalAlignment="Right">
                <Button Content="Delete Anyway"
                        Command="{Binding
                            ConfirmDeleteAllCommand}" />
                <Button Content="Cancel"
                        Command="{Binding
                            CancelDeleteAllCommand}" />
            </StackPanel>
        </StackPanel>
    </Border>

    <!-- Scenario switch confirmation overlay -->
    <Border IsVisible="{Binding
                ShowScenarioSwitchConfirmation}"
            Background="#CC000000"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            CornerRadius="8"
            Padding="24"
            MinWidth="350">
        <StackPanel Spacing="12">
            <TextBlock Text="Switch Scenario?"
                       FontSize="16"
                       FontWeight="Bold"
                       Foreground="White" />
            <TextBlock TextWrapping="Wrap"
                       Foreground="LightGray">
                <Run Text="You are currently in scenario " />
                <Run Text="{Binding ActiveScenarioName}"
                     FontWeight="Bold" />
                <Run Text=". Loading a new scenario will " />
                <Run Text="leave the current one." />
            </TextBlock>
            <StackPanel Orientation="Horizontal"
                        Spacing="8"
                        HorizontalAlignment="Right">
                <Button Content="Switch"
                        Command="{Binding
                            ConfirmScenarioSwitchCommand}" />
                <Button Content="Cancel"
                        Command="{Binding
                            CancelScenarioSwitchCommand}" />
            </StackPanel>
        </StackPanel>
    </Border>

    <!-- Active scenarios (crash recovery) overlay -->
    <Border IsVisible="{Binding ShowActiveScenarios}"
            Background="#CC000000"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            CornerRadius="8"
            Padding="24"
            MinWidth="400"
            MaxHeight="400">
        <StackPanel Spacing="12">
            <TextBlock Text="Active Scenarios Found"
                       FontSize="16"
                       FontWeight="Bold"
                       Foreground="White" />
            <TextBlock Text="Resumable scenarios are
                       running on the server."
                       Foreground="LightGray"
                       TextWrapping="Wrap" />
            <ItemsControl
                ItemsSource="{Binding ActiveScenarios}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="svc:ScenarioSessionInfoDto">
                        <Border Margin="0,4"
                                Padding="8"
                                Background="#40FFFFFF"
                                CornerRadius="4">
                            <Grid
                                ColumnDefinitions="*,Auto">
                                <StackPanel Grid.Column="0">
                                    <TextBlock
                                        Text="{Binding
                                            ScenarioName}"
                                        FontWeight="Bold"
                                        Foreground="White"/>
                                    <TextBlock
                                        Foreground="Gray"
                                        FontSize="11">
                                        <Run Text="{Binding
                                            AircraftCount}" />
                                        <Run Text=" aircraft," />
                                        <Run Text="{Binding
                                            ClientCount}" />
                                        <Run Text=" client(s)" />
                                    </TextBlock>
                                </StackPanel>
                                <Button Grid.Column="1"
                                    Content="Rejoin"
                                    VerticalAlignment="Center"
                                    Command="{Binding $parent[Window].DataContext.RejoinScenarioCommand}"
                                    CommandParameter="{Binding ScenarioId}"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
            <Button Content="Dismiss"
                    HorizontalAlignment="Right"
                    Command="{Binding
                        DismissActiveScenariosCommand}" />
        </StackPanel>
    </Border>

    </Panel>
</Window>
