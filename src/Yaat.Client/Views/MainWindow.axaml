<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Yaat.Client.ViewModels"
        xmlns:svc="using:Yaat.Client.Services"
        xmlns:views="using:Yaat.Client.Views"
        x:Class="Yaat.Client.Views.MainWindow"
        Icon="avares://Yaat.Client/Resources/icon.png"
        Title="YAAT">

    <Design.DataContext>
        <vm:MainViewModel />
    </Design.DataContext>

    <Panel>

    <DockPanel Margin="12">

        <!-- Top bar: URL + Connect + Settings -->
        <Grid DockPanel.Dock="Top"
              Margin="0,0,0,8"
              ColumnDefinitions="Auto,Auto,*,Auto">
            <TextBox Grid.Column="0"
                     Text="{Binding ServerUrl}"
                     Watermark="Server URL"
                     Width="300" />
            <Button Grid.Column="1"
                    Margin="8,0,0,0"
                    Content="{Binding IsConnected,
                    Converter={x:Static
                    vm:ConnectButtonConverter.Instance}}"
                    Command="{Binding ConnectCommand}" />
            <TextBlock Grid.Column="2"
                       Text="{Binding StatusText}"
                       VerticalAlignment="Center"
                       Margin="12,0,0,0"
                       Foreground="Gray" />
            <Button Grid.Column="3"
                    Content="Settings"
                    x:Name="SettingsButton" />
        </Grid>

        <!-- Room + Scenario bar -->
        <StackPanel DockPanel.Dock="Top"
                    Orientation="Horizontal"
                    Spacing="8"
                    Margin="0,0,0,8">
            <!-- Room indicator -->
            <TextBlock VerticalAlignment="Center"
                       Foreground="CornflowerBlue"
                       IsVisible="{Binding ActiveRoomName,
                           Converter={x:Static
                           StringConverters.IsNotNullOrEmpty}}"
                       Text="{Binding ActiveRoomName}" />
            <Button Content="Leave Room"
                    Command="{Binding LeaveRoomCommand}"
                    IsVisible="{Binding ActiveRoomName,
                        Converter={x:Static
                        StringConverters.IsNotNullOrEmpty}}" />
            <Button Content="Rooms"
                    Command="{Binding RefreshRoomListCommand}"
                    IsVisible="{Binding ActiveRoomName,
                        Converter={x:Static
                        StringConverters.IsNullOrEmpty}}" />

            <Border Width="1" Background="#3F3F46"
                    Margin="4,2"
                    IsVisible="{Binding ActiveRoomName,
                        Converter={x:Static
                        StringConverters.IsNotNullOrEmpty}}" />

            <!-- Scenario controls -->
            <TextBox Text="{Binding ScenarioFilePath}"
                     Watermark="Scenario JSON file..."
                     Width="400"
                     IsVisible="{Binding ActiveRoomName,
                         Converter={x:Static
                         StringConverters.IsNotNullOrEmpty}}" />
            <Button Content="Browse"
                    x:Name="BrowseButton"
                    IsVisible="{Binding ActiveRoomName,
                        Converter={x:Static
                        StringConverters.IsNotNullOrEmpty}}" />
            <Button Content="Load"
                    Command="{Binding LoadScenarioCommand}"
                    IsVisible="{Binding ActiveRoomName,
                        Converter={x:Static
                        StringConverters.IsNotNullOrEmpty}}" />
            <Button Content="Unload"
                    Command="{Binding UnloadScenarioCommand}"
                    IsVisible="{Binding ActiveScenarioName,
                        Converter={x:Static
                        StringConverters.IsNotNullOrEmpty}}" />

            <!-- Active scenario indicator -->
            <TextBlock VerticalAlignment="Center"
                       Margin="8,0,0,0"
                       Foreground="LightGreen"
                       IsVisible="{Binding ActiveScenarioName,
                           Converter={x:Static
                           StringConverters.IsNotNullOrEmpty}}"
                       Text="{Binding ActiveScenarioName,
                           StringFormat='Scenario: {0}'}" />
        </StackPanel>

        <!-- Bottom: Command input (visible when docked) -->
        <views:CommandInputView DockPanel.Dock="Bottom"
            IsVisible="{Binding IsTerminalDocked}" />

        <!-- Center: DataGrid + Terminal with splitter -->
        <Grid RowDefinitions="3*,Auto,*">
            <DataGrid Grid.Row="0"
                      x:Name="AircraftGrid"
                      ItemsSource="{Binding Aircraft}"
                      SelectedItem="{Binding SelectedAircraft}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      GridLinesVisibility="Horizontal"
                      CanUserResizeColumns="True"
                  CanUserReorderColumns="True"
                      SelectionMode="Single"
                      RowDetailsVisibilityMode="VisibleWhenSelected">
                <DataGrid.RowDetailsTemplate>
                    <DataTemplate>
                        <Border Padding="12,6"
                                Background="#0AFFFFFF"
                                BorderBrush="#1AFFFFFF"
                                BorderThickness="0,1">
                            <StackPanel Spacing="3">
                                <!-- Phases -->
                                <StackPanel Orientation="Horizontal"
                                            IsVisible="{Binding HasPhases}">
                                    <TextBlock Text="Phases"
                                               Width="80"
                                               Foreground="Gray"
                                               FontSize="12" />
                                    <TextBlock Text="{Binding PhaseSequenceDisplay}"
                                               FontFamily="Consolas"
                                               FontSize="12" />
                                </StackPanel>
                                <!-- Pattern -->
                                <StackPanel Orientation="Horizontal"
                                            IsVisible="{Binding HasPattern}">
                                    <TextBlock Text="Pattern"
                                               Width="80"
                                               Foreground="Gray"
                                               FontSize="12" />
                                    <TextBlock Text="{Binding PatternDisplay}"
                                               FontSize="12" />
                                </StackPanel>
                                <!-- Clearance -->
                                <StackPanel Orientation="Horizontal"
                                            IsVisible="{Binding HasClearance}">
                                    <TextBlock Text="Clearance"
                                               Width="80"
                                               Foreground="Gray"
                                               FontSize="12" />
                                    <TextBlock Text="{Binding ClearanceDisplay}"
                                               Foreground="LightGreen"
                                               FontSize="12" />
                                </StackPanel>
                                <!-- Navigation Route -->
                                <StackPanel Orientation="Horizontal"
                                            IsVisible="{Binding HasNavigationRoute}">
                                    <TextBlock Text="Route"
                                               Width="80"
                                               Foreground="Gray"
                                               FontSize="12" />
                                    <TextBlock Text="{Binding NavigationRoute}"
                                               FontSize="12" />
                                </StackPanel>
                                <!-- Cruise -->
                                <StackPanel Orientation="Horizontal"
                                            IsVisible="{Binding HasCruise}">
                                    <TextBlock Text="Cruise"
                                               Width="80"
                                               Foreground="Gray"
                                               FontSize="12" />
                                    <TextBlock Text="{Binding CruiseDisplay}"
                                               FontSize="12" />
                                </StackPanel>
                                <!-- Pending Commands (full, when present) -->
                                <StackPanel Orientation="Horizontal"
                                            IsVisible="{Binding PendingCommands,
                                                Converter={x:Static
                                                StringConverters.IsNotNullOrEmpty}}">
                                    <TextBlock Text="Pending"
                                               Width="80"
                                               Foreground="Gray"
                                               FontSize="12" />
                                    <TextBlock Text="{Binding PendingCommands}"
                                               FontSize="12"
                                               TextWrapping="Wrap" />
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </DataGrid.RowDetailsTemplate>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Callsign"
                        Binding="{Binding Callsign}"
                        Width="Auto" />
                    <DataGridTextColumn Header="Status"
                        Binding="{Binding StatusDisplay}"
                        Width="Auto" />
                    <DataGridTextColumn Header="Owner"
                        Binding="{Binding OwnerDisplay}"
                        Width="Auto" />
                    <DataGridTextColumn Header="HO"
                        Binding="{Binding HandoffDisplay}"
                        Width="Auto" />
                    <DataGridTextColumn Header="SP"
                        Binding="{Binding Scratchpad1}"
                        Width="Auto" />
                    <DataGridTextColumn Header="TA"
                        Binding="{Binding TempAltDisplay}"
                        Width="Auto" />
                    <DataGridTextColumn Header="Phase"
                        Binding="{Binding CurrentPhase}"
                        Width="Auto" />
                    <DataGridTextColumn Header="Rwy"
                        Binding="{Binding AssignedRunway}"
                        Width="Auto" />
                    <DataGridTextColumn Header="Type"
                        Binding="{Binding AircraftType}"
                        Width="Auto" />
                    <DataGridTextColumn Header="Rules"
                        Binding="{Binding FlightRules}"
                        Width="Auto" />
                    <DataGridTextColumn Header="Dep"
                        Binding="{Binding Departure}"
                        Width="Auto" />
                    <DataGridTextColumn Header="Dest"
                        Binding="{Binding Destination}"
                        Width="Auto" />
                    <DataGridTextColumn Header="Squawk"
                        Binding="{Binding BeaconCode,
                        StringFormat=\{0:D4\}}"
                        Width="Auto" />
                    <DataGridTextColumn Header="Hdg"
                        Binding="{Binding Heading,
                        StringFormat=\{0:F0\}}"
                        Width="Auto" />
                    <DataGridTextColumn Header="Alt"
                        Binding="{Binding Altitude,
                        StringFormat=\{0:F0\}}"
                        Width="Auto" />
                    <DataGridTextColumn Header="Spd"
                        Binding="{Binding GroundSpeed,
                        StringFormat=\{0:F0\}}"
                        Width="Auto" />
                    <DataGridTextColumn Header="VS"
                        Binding="{Binding VerticalSpeed,
                        StringFormat=\{0:F0\}}"
                        Width="Auto" />
                    <DataGridTextColumn Header="AHdg"
                        Binding="{Binding AssignedHeadingDisplay}"
                        Width="Auto" />
                    <DataGridTextColumn Header="AAlt"
                        Binding="{Binding AssignedAltitude,
                        StringFormat=\{0:F0\}}"
                        Width="Auto" />
                    <DataGridTextColumn Header="ASpd"
                        Binding="{Binding AssignedSpeed,
                        StringFormat=\{0:F0\}}"
                        Width="Auto" />
                    <DataGridTemplateColumn Width="Auto"
                        SortMemberPath="DistanceFromFix">
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{Binding
                                DataContext.DistanceReferenceFix,
                                RelativeSource={RelativeSource
                                    AncestorType=Window},
                                StringFormat='Dist ({0})',
                                FallbackValue='Dist'}"
                                x:Name="DistanceHeader" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock
                                    Text="{Binding DistanceFromFix,
                                        StringFormat='\{0:F1\}'}"
                                    Margin="4,0"
                                    VerticalAlignment="Center" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTextColumn Header="Pending Cmds"
                        Binding="{Binding PendingCommands}"
                        Width="Auto" />
                </DataGrid.Columns>
            </DataGrid>

            <GridSplitter Grid.Row="1"
                          Height="6"
                          Background="#3F3F46"
                          IsVisible="{Binding IsTerminalDocked}" />

            <views:TerminalPanelView Grid.Row="2"
                IsVisible="{Binding IsTerminalDocked}" />
        </Grid>

    </DockPanel>

    <!-- Delete-all confirmation overlay -->
    <Border IsVisible="{Binding ShowUnloadScenarioConfirmation}"
            Background="#CC000000"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            CornerRadius="8"
            Padding="24"
            MinWidth="350">
        <StackPanel Spacing="12">
            <TextBlock Text="Delete All Aircraft?"
                       FontSize="16"
                       FontWeight="Bold"
                       Foreground="White" />
            <TextBlock Text="{Binding PendingUnloadScenarioWarning}"
                       TextWrapping="Wrap"
                       Foreground="Orange" />
            <StackPanel Orientation="Horizontal"
                        Spacing="8"
                        HorizontalAlignment="Right">
                <Button Content="Delete Anyway"
                        Command="{Binding
                            ConfirmUnloadScenarioCommand}" />
                <Button Content="Cancel"
                        Command="{Binding
                            CancelUnloadScenarioCommand}" />
            </StackPanel>
        </StackPanel>
    </Border>

    <!-- Scenario switch confirmation overlay -->
    <Border IsVisible="{Binding
                ShowScenarioSwitchConfirmation}"
            Background="#CC000000"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            CornerRadius="8"
            Padding="24"
            MinWidth="350">
        <StackPanel Spacing="12">
            <TextBlock Text="Replace Scenario?"
                       FontSize="16"
                       FontWeight="Bold"
                       Foreground="White" />
            <TextBlock TextWrapping="Wrap"
                       Foreground="LightGray">
                <Run Text="Scenario " />
                <Run Text="{Binding ActiveScenarioName}"
                     FontWeight="Bold" />
                <Run Text=" is currently loaded. Loading a " />
                <Run Text="new scenario will replace it." />
            </TextBlock>
            <StackPanel Orientation="Horizontal"
                        Spacing="8"
                        HorizontalAlignment="Right">
                <Button Content="Replace"
                        Command="{Binding
                            ConfirmScenarioSwitchCommand}" />
                <Button Content="Cancel"
                        Command="{Binding
                            CancelScenarioSwitchCommand}" />
            </StackPanel>
        </StackPanel>
    </Border>

    <!-- Difficulty selection overlay -->
    <Border IsVisible="{Binding ShowDifficultySelection}"
            Background="#CC000000"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            CornerRadius="8"
            Padding="24"
            MinWidth="350">
        <StackPanel Spacing="12">
            <TextBlock Text="Select Difficulty"
                       FontSize="16"
                       FontWeight="Bold"
                       Foreground="White" />
            <TextBlock Text="Choose the maximum difficulty level.
                       Higher levels include all lower ones."
                       TextWrapping="Wrap"
                       Foreground="LightGray" />
            <ListBox
                ItemsSource="{Binding DifficultyOptions}"
                SelectedIndex="{Binding
                    SelectedDifficultyIndex}">
                <ListBox.ItemTemplate>
                    <DataTemplate
                        x:DataType="vm:DifficultyOption">
                        <TextBlock
                            Text="{Binding Display}" />
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
            <StackPanel Orientation="Horizontal"
                        Spacing="8"
                        HorizontalAlignment="Right">
                <Button Content="Load"
                        Command="{Binding
                            ConfirmDifficultySelectionCommand}" />
                <Button Content="Cancel"
                        Command="{Binding
                            CancelDifficultySelectionCommand}" />
            </StackPanel>
        </StackPanel>
    </Border>

    <!-- Room list overlay -->
    <Border IsVisible="{Binding ShowRoomList}"
            Background="#CC000000"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            CornerRadius="8"
            Padding="24"
            MinWidth="500"
            MaxHeight="500">
        <StackPanel Spacing="12">
            <TextBlock Text="Training Rooms"
                       FontSize="16"
                       FontWeight="Bold"
                       Foreground="White" />
            <TextBlock Text="Create a new room or join an
                       existing one."
                       Foreground="LightGray"
                       TextWrapping="Wrap" />
            <ItemsControl
                ItemsSource="{Binding ActiveRooms}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate
                        x:DataType="svc:TrainingRoomInfoDto">
                        <Border Margin="0,4"
                                Padding="8"
                                Background="#40FFFFFF"
                                CornerRadius="4">
                            <Grid
                                ColumnDefinitions="*,Auto">
                                <StackPanel Grid.Column="0">
                                    <TextBlock
                                        FontWeight="Bold"
                                        Foreground="White">
                                        <Run Text="(" /><Run
                                            Text="{Binding
                                            CreatorArtccId}"
                                        /><Run Text=") " /><Run
                                            Text="{Binding
                                            CreatorInitials}"
                                        /><Run Text="'s Room" />
                                    </TextBlock>
                                    <TextBlock
                                        Foreground="Gray"
                                        FontSize="11">
                                        <Run Text="{Binding
                                            ScenarioName,
                                            TargetNullValue='No scenario'}" />
                                        <Run Text=" · " />
                                        <Run Text="{Binding
                                            AircraftCount}" />
                                        <Run Text=" aircraft · " />
                                        <Run Text="{Binding
                                            MemberInitials.Count}" />
                                        <Run Text=" member(s)" />
                                    </TextBlock>
                                </StackPanel>
                                <Button Grid.Column="1"
                                    Content="Join"
                                    VerticalAlignment="Center"
                                    Command="{Binding
                                        $parent[Window].DataContext.JoinRoomCommand}"
                                    CommandParameter="{Binding
                                        RoomId}"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
            <StackPanel Orientation="Horizontal"
                        Spacing="8"
                        HorizontalAlignment="Right">
                <Button Content="Create Room"
                        Command="{Binding
                            CreateRoomCommand}" />
                <Button Content="Refresh"
                        Command="{Binding
                            RefreshRoomListCommand}" />
                <Button Content="Dismiss"
                        Command="{Binding
                            DismissRoomListCommand}" />
            </StackPanel>
        </StackPanel>
    </Border>

    </Panel>
</Window>
